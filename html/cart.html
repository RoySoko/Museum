<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="robots" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shopping Cart – The Museum of Royce the Great</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .cart-wrap{ max-width: 1100px; margin: 2rem auto; padding: 0 1rem; }
    .cart-title{ text-align:center; color:#3d5a3d; font: 700 1.6rem Georgia, serif; margin-bottom:.75rem; }

    table.cart { width:100%; border-collapse:collapse; margin: .5rem 0 1rem; background: rgba(243,233,210,.95); border:1px solid #c8bfae; }
    .cart th, .cart td{ padding:.6rem .5rem; border:1px solid #c8bfae; vertical-align:middle; }
    .cart th{ text-align:left; background:#eee4cc; }
    .cart .thumb{ width:64px; height:48px; object-fit:cover; border-radius:6px; display:block; }
    .cart .amt{ text-align:right; font-variant-numeric: tabular-nums; white-space:nowrap; }
    .cart .rmv{ background:#c94f4f; color:#fff; border:0; padding:.35rem .55rem; border-radius:6px; cursor:pointer; }
    .cart .rmv:hover{ background:#d76666; }

    .summary{ display:grid; grid-template-columns: 1fr 280px; gap:.75rem; align-items:start; }
    .summary-box{
      background: rgba(243,233,210,.95);
      border:1px solid #c8bfae; border-radius:10px;
      padding:1rem; box-shadow: 0 2px 6px rgba(0,0,0,.08);
    }
    .summary-box table{ width:100%; border-collapse:collapse; }
    .summary-box td{ padding:.25rem 0; }
    .summary-box td:last-child{ text-align:right; font-variant-numeric: tabular-nums; white-space:nowrap; }

    .actions{ margin:.75rem 0 1rem; display:flex; gap:.75rem; }
    .btn{ background:#8b5e34; color:#fff; border:0; padding:.45rem .8rem; border-radius:6px; cursor:pointer; }
    .btn:hover{ background:#a1683a; }
    .link{ color:#0a0a0a; text-decoration:underline; background:none; border:0; cursor:pointer; padding:0; }

    .member{ margin:.5rem 0 1rem; }
    .note{ color:#555; font-size:.9rem; margin:.25rem 0 0; }
  </style>
</head>
<body class="collections-page">
  <header class="site-header">
    <h1>The Museum of Royce the Great, Wirehaired Wonder</h1>
    <nav class="main-nav">
      <button onclick="location.href='../index.html'">Home</button>
      <button onclick="location.href='staff.html'">Staff</button>
      <button onclick="location.href='collections.html'">Collections</button>
      <button onclick="location.href='shop.html'">Shop</button>
    </nav>
  </header>

  <main class="cart-wrap">
    <h2 class="cart-title">Shopping Cart</h2>

    <div class="member">
      <label>
        <input type="checkbox" id="memberChk" onchange="render()"> Member Discount (15%)
      </label>
      <div class="note">Volume discount applies at $50 / $100 / $200. If both apply, you’ll choose one.</div>
    </div>

    <table class="cart" id="cartTable" aria-describedby="summary">
      <thead>
        <tr>
          <th style="width:90px;">Item</th>
          <th>Name</th>
          <th style="width:70px;">Qty</th>
          <th style="width:120px;">Unit Price</th>
          <th style="width:140px;">Line Total</th>
          <th style="width:120px;">Remove</th>
        </tr>
      </thead>
      <tbody id="cartRows"></tbody>
    </table>

    <div class="summary" id="summary">
      <div>
        <div class="actions">
          <button class="btn" onclick="window.__clearCart=1; render();">Clear Cart</button>
          <button class="link" onclick="location.href='shop.html'">Keep Shopping</button>
        </div>
      </div>

      <div class="summary-box" aria-live="polite">
        <table>
          <tbody id="summaryRows"></tbody>
        </table>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <p>This is a fictitious website created purely for academic purposes.</p>
    <p>The content in this shop was created by AI under human direction and then curated/edited by a human.</p>
  </footer>

  <script>
    /* Single render() (no other functions) — reads array cart from CART_KEY, builds rows, and does the math */
    function render(){
      // =================== CONSTANTS + KEY ===================
      var CART_KEY = 'museumCartV1'; // <-- matches shop page
      var TAX_RATE = 0.102;          // 10.2%
      var MEMBER_RATE = 0.15;        // 15%
      var SHIPPING_FLAT = 25.00;     // flat if cart not empty
      var TIERS = [
        { min: 0,    max: 49.99,  rate: 0.00 },
        { min: 50,   max: 99.99,  rate: 0.05 },
        { min: 100,  max: 199.99, rate: 0.10 },
        { min: 200,  max: 1e12,   rate: 0.15 }
      ];

      // =================== READ CART (ARRAY) ===================
      var cart = [];
      try { cart = JSON.parse(localStorage.getItem(CART_KEY) || '[]'); } catch(e){ cart = []; }

      // drop invalid entries (qty <= 0 or unitPrice <= 0) per edge-case rule
      var cleaned = [];
      for (var ci=0; ci<cart.length; ci++){
        var it = cart[ci];
        if (!it) continue;
        var q = Number(it.qty)||0, p = Number(it.unitPrice)||0;
        if (q > 0 && p > 0){
          cleaned.push({ id: it.id, name: it.name, unitPrice: p, qty: q, image: it.image });
        }
      }
      // apply inline commands (clear/remove) without making helper functions
      if (window.__clearCart){ cleaned = []; window.__clearCart = 0; }
      if (window.__removeId){
        var rid = window.__removeId;
        var kept = [];
        for (var ri=0; ri<cleaned.length; ri++){
          if (cleaned[ri].id !== rid) kept.push(cleaned[ri]);
        }
        cleaned = kept;
        window.__removeId = '';
      }
      // persist any cleanup/changes
      try { localStorage.setItem(CART_KEY, JSON.stringify(cleaned)); } catch(e){}
      cart = cleaned;

      // =================== MEMBER CHECKBOX STATE ===================
      var member = false;
      try { member = (localStorage.getItem('member') === 'true'); } catch(e){ member = false; }
      var memberChk = document.getElementById('memberChk');
      if (memberChk){
        if (memberChk.checked !== member) memberChk.checked = member;
        member = memberChk.checked ? true : false; // reflect UI
        try { localStorage.setItem('member', member ? 'true' : 'false'); } catch(e){}
      }

      // =================== BUILD TABLE ROWS ===================
      var rowsEl = document.getElementById('cartRows');
      if (rowsEl){
        if (cart.length === 0){
          rowsEl.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:1rem;">Your cart is empty.</td></tr>';
        } else {
          var html = '';
          for (var i=0; i<cart.length; i++){
            var it2 = cart[i];
            var lineTotal = (it2.unitPrice||0) * (it2.qty||0);
            var sUnit = '$' + Math.abs((it2.unitPrice||0)).toFixed(2);
            var sLine = '$' + Math.abs(lineTotal).toFixed(2);
            html += ''
              + '<tr>'
              +   '<td><img class="thumb" src="'+(it2.image||'')+'" alt=""></td>'
              +   '<td>'+(it2.name||'')+'</td>'
              +   '<td class="amt">'+(it2.qty||0)+'</td>'
              +   '<td class="amt">'+sUnit+'</td>'
              +   '<td class="amt">'+sLine+'</td>'
              +   '<td><button class="rmv" onclick="window.__removeId=\''+(it2.id||'')+'\'; render();">Remove</button></td>'
              + '</tr>';
          }
          rowsEl.innerHTML = html;
        }
      }

      // =================== SUMMARY MATH (UNROUNDED) ===================
      var itemTotal = 0;
      for (var k=0; k<cart.length; k++){
        itemTotal += (Number(cart[k].unitPrice)||0) * (Number(cart[k].qty)||0);
      }

      // tier rate
      var volumeRate = 0;
      for (var t=0; t<TIERS.length; t++){
        var tier = TIERS[t];
        if (itemTotal >= tier.min && itemTotal <= tier.max){ volumeRate = tier.rate; break; }
      }
      var volumeDiscount = itemTotal * volumeRate;
      var memberDiscount  = member ? itemTotal * MEMBER_RATE : 0;

      // one-discount rule
      var appliedMember = false, appliedVolume = false, discount = 0;
      if (memberDiscount > 0 && volumeDiscount > 0){
        var useMember = window.confirm('Both a Volume Discount and a Member Discount are available.\nClick "OK" to use the Member Discount (15%), or "Cancel" to use the Volume Discount.');
        if (useMember){ appliedMember = true; discount = memberDiscount; }
        else { appliedVolume = true; discount = volumeDiscount; }
      } else if (memberDiscount > 0){
        appliedMember = true; discount = memberDiscount;
      } else if (volumeDiscount > 0){
        appliedVolume = true; discount = volumeDiscount;
      }

      var shipping = cart.length > 0 ? SHIPPING_FLAT : 0;
      var taxableSub = itemTotal - discount + shipping;
      var taxAmt = taxableSub * TAX_RATE;
      var invoiceTotal = taxableSub + taxAmt;

      // =================== FORMATTED STRINGS (PARENTHESES FOR NEGATIVES) ===================
      var sItem = '$' + Math.abs(itemTotal).toFixed(2);
      var sVol  = appliedVolume ? '(' + '$' + (discount).toFixed(2) + ')' : '$0.00';
      var sMem  = appliedMember ? '(' + '$' + (discount).toFixed(2) + ')' : '$0.00';
      var sShip = '$' + Math.abs(shipping).toFixed(2);
      var sTaxb = '$' + Math.abs(taxableSub).toFixed(2);
      var sTaxR = (TAX_RATE*100).toFixed(2) + '%';
      var sTaxA = '$' + Math.abs(taxAmt).toFixed(2);
      var sInv  = '$' + Math.abs(invoiceTotal).toFixed(2);

      // =================== SUMMARY OUTPUT ===================
      var srows = document.getElementById('summaryRows');
      if (srows){
        srows.innerHTML = ''
          + '<tr><td>Subtotal of Items</td><td>'+sItem+'</td></tr>'
          + '<tr><td>Volume Discount</td><td>'+sVol+'</td></tr>'
          + '<tr><td>Member Discount</td><td>'+sMem+'</td></tr>'
          + '<tr><td>Shipping</td><td>'+sShip+'</td></tr>'
          + '<tr><td><strong>Subtotal (Taxable amount)</strong></td><td><strong>'+sTaxb+'</strong></td></tr>'
          + '<tr><td>Tax Rate</td><td>'+sTaxR+'</td></tr>'
          + '<tr><td>Tax Amount</td><td>'+sTaxA+'</td></tr>'
          + '<tr><td><strong>Invoice Total</strong></td><td><strong>'+sInv+'</strong></td></tr>';
      }

      // =================== PERSIST (ALREADY DONE) ===================
      try { localStorage.setItem(CART_KEY, JSON.stringify(cart)); } catch(e){}
    }
  </script>
  <script>render();</script>
</body>
</html>
